"""
–°–∫–æ–ª—å–∑—è—â–∞—è –≤—ã–∂–∏–º–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ –≤—ã–∂–∏–º–æ–∫
"""
import hashlib
from pathlib import Path
from typing import List, Dict
from shared.ai.gpt5_client import get_openai_client, parse_gpt5_response


def analyze_summaries(summaries_text: str, client=None) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –≤—ã–∂–∏–º–∫–∏ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã.
    –≠—Ç–æ –Ω–µ —Å–∂–∞—Ç–∏–µ, –∞ –∞–Ω–∞–ª–∏–∑ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
    
    Args:
        summaries_text: –¢–µ–∫—Å—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –≤—ã–∂–∏–º–æ–∫
        client: OpenAI –∫–ª–∏–µ–Ω—Ç (–µ—Å–ª–∏ None, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π)
    
    Returns:
        –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –∑–∞–¥–∞—á, —Ä–µ—à–µ–Ω–∏–π –∏ –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
    """
    if client is None:
        client = get_openai_client()
    
    system_prompt = """–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —É–∂–µ —Å–∂–∞—Ç—ã–µ –≤—ã–∂–∏–º–∫–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É –§–∞—Ä–º–∞+.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∂–∏–º–∫–∏ –∏ –≤—ã–¥–µ–ª–∏—Ç—å:
- –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è
- –ü—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è
- –ü–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –î–µ–¥–ª–∞–π–Ω—ã –∏ —Å—Ä–æ–∫–∏
- –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É

–û–±—ä–µ–¥–∏–Ω–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≤—Å–µ—Ö –≤—ã–∂–∏–º–æ–∫, —É–¥–∞–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–æ —Ç–µ–º–∞–º.
–í–µ—Ä–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –≥–æ—Ç–æ–≤—ã–π –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–∞–¥–∞—á."""
    
    user_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –≤—ã–∂–∏–º–∫–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏:

{summaries_text}

–í–µ—Ä–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –∑–∞–¥–∞—á, —Ä–µ—à–µ–Ω–∏–π –∏ –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤."""
    
    try:
        response = client.responses.create(
            model="gpt-5",
            input=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            reasoning={"effort": "medium"}
        )
        
        # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
        result = parse_gpt5_response(response)
        if result:
            return result
        
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∞–Ω–∞–ª–∏–∑ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏"
    except Exception as e:
        print(f"      ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –≤—ã–∂–∏–º–æ–∫: {e}")
        return summaries_text  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏


def apply_sliding_window(
    compressed_chunks: List[str],
    output_dir: Path,
    cache_dir: Path,
    client=None
) -> str:
    """
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∫–æ–ª—å–∑—è—â—É—é –≤—ã–∂–∏–º–∫—É: –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≤—ã–∂–∏–º–∫–∏ + –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–∂–∏–º–∫–∞.
    
    Args:
        compressed_chunks: –°–ø–∏—Å–æ–∫ —Å–∂–∞—Ç—ã—Ö —á–∞–Ω–∫–æ–≤
        output_dir: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        cache_dir: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∫–µ—à–∞
        client: OpenAI –∫–ª–∏–µ–Ω—Ç (–µ—Å–ª–∏ None, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π)
    
    Returns:
        –§–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–∂–∏–º–∫–∞ –ø–æ—Å–ª–µ —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –æ–∫–Ω–∞
    """
    print(f"\n   üîÑ –°–∫–æ–ª—å–∑—è—â–∞—è –≤—ã–∂–∏–º–∫–∞ (–∞–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 –≤—ã–∂–∏–º–æ–∫ + –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–∂–∏–º–∫–∞)...")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ñ–∏–Ω–∞–ª—å–Ω—É—é –≤—ã–∂–∏–º–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    previous_summary_file = output_dir / "previous_summary.txt"
    previous_summary = ""
    if previous_summary_file.exists():
        with open(previous_summary_file, "r", encoding="utf-8") as f:
            previous_summary = f.read()
        print(f"   ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–∂–∏–º–∫–∞ ({len(previous_summary)} —Å–∏–º–≤–æ–ª–æ–≤)")
    
    # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≤—ã–∂–∏–º–∫–∏ (—É–∂–µ —Å–∂–∞—Ç—ã–µ —á–∞—Å—Ç–∏)
    last_3_summaries = compressed_chunks[-3:] if len(compressed_chunks) >= 3 else compressed_chunks
    new_summaries_text = '\n\n'.join(last_3_summaries)
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤—ã–∂–∏–º–∫—É —Å –Ω–æ–≤—ã–º–∏ –≤—ã–∂–∏–º–∫–∞–º–∏
    if previous_summary:
        combined_for_analysis = f"{previous_summary}\n\n--- –ù–û–í–´–ï –í–´–ñ–ò–ú–ö–ò ---\n\n{new_summaries_text}"
    else:
        combined_for_analysis = new_summaries_text
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –≤—ã–∂–∏–º–∫–∏ (–Ω–µ —Å–∂–∏–º–∞–µ–º, –∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–∞–¥–∞—á)
    print(f"   –ê–Ω–∞–ª–∏–∑ —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –æ–∫–Ω–∞ –≤—ã–∂–∏–º–æ–∫ ({len(combined_for_analysis)} —Å–∏–º–≤–æ–ª–æ–≤)...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –æ–∫–Ω–∞
    analysis_hash = hashlib.sha256(combined_for_analysis.encode('utf-8')).hexdigest()[:16]
    sliding_cache_file = cache_dir / f"sliding_analysis_{analysis_hash}.txt"
    
    if sliding_cache_file.exists():
        print(f"   üíæ –ù–∞–π–¥–µ–Ω –∫–µ—à –¥–ª—è —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (—Ö–µ—à: {analysis_hash})...", flush=True)
        with open(sliding_cache_file, "r", encoding="utf-8") as f:
            final_summary = f.read()
        print(f"   ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∫–µ—à–∞: {len(final_summary)} —Å–∏–º–≤–æ–ª–æ–≤")
    else:
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–∂–∏–º–∫–∏ (–∏–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã, –∑–∞–¥–∞—á–∏, —Ä–µ—à–µ–Ω–∏—è)
        final_summary = analyze_summaries(combined_for_analysis, client)
        print(f"   ‚úì –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –∏—Ç–æ–≥–æ–≤–∞—è –≤—ã–∂–∏–º–∫–∞: {len(final_summary)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
        with open(sliding_cache_file, "w", encoding="utf-8") as f:
            f.write(final_summary)
        print(f"   üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫–µ—à: {sliding_cache_file}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ñ–∏–Ω–∞–ª—å–Ω—É—é –≤—ã–∂–∏–º–∫—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–∞
    with open(previous_summary_file, "w", encoding="utf-8") as f:
        f.write(final_summary)
    print(f"   üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–∂–∏–º–∫–∞: {previous_summary_file}")
    
    return final_summary

