# План тестирования модуля синхронизации V2

**Дата обновления:** 2025-11-10  
**Версия архитектуры:** V2 (временные окна + кеш эмбеддингов)

## Текущее состояние модуля

### ✅ Реализованные компоненты V2

#### Компонент 1: Временные окна
- ✅ Извлечение дат из контекста Telegram задач
- ✅ Определение временных окон (основное ±7 дней, расширенное ±30 дней)
- ✅ Фильтрация задач Asana по окнам
- ✅ Приоритизация кандидатов по окнам

#### Компонент 2: Кеш эмбеддингов
- ✅ Локальное кеширование эмбеддингов
- ✅ Автоматическая загрузка/сохранение кеша между запусками
- ✅ Статистика использования (hits/misses/hit rate)
- ✅ Оптимизированное сохранение (периодически, не после каждого запроса)

#### Компонент 3: Батчинг запросов
- ✅ Батчинг эмбеддингов для Telegram задач (100 элементов)
- ✅ Батчинг эмбеддингов для Asana задач (100 элементов)
- ✅ Оптимизация затрат (~98% экономии на запросах к API)

#### Компонент 4: Двухэтапное сопоставление
- ✅ Предварительная проверка точных совпадений названий
- ✅ Поиск через эмбеддинги с разными порогами по окнам
- ✅ GPT-5 проверка для потенциальных совпадений (low_threshold <= score < similarity_threshold)
- ✅ Обработка дубликатов (одна задача Asana = одна Telegram)

## Файлы для тестирования

### Основной скрипт
- **`scripts/sync_farma.py`** ✅ Обновлен на V2
  - Использует `find_matching_tasks_v2`
  - Включены временные окна и кеш
  - Батчинг запросов к OpenAI

### Тестовый скрипт
- **`tests/test_v2.py`** ✅ Новый тест для V2 архитектуры
  - Тестирует временные окна
  - Проверяет кеш эмбеддингов
  - Выводит статистику использования

### Удаленные устаревшие файлы
- ❌ `run_full_test.py` - удален (использовал старый метод)
- ❌ `run_sync_now.py` - удален (дублировал функциональность)
- ❌ `test_integration.py` - удален (неполный тест)

## План тестирования

### Этап 1: Локальное тестирование V2 ✅

**Цель:** Проверить работу новой архитектуры на реальных данных

**Шаги:**
1. Запустить `test_v2.py` с файлом задач Asana
2. Проверить работу временных окон
3. Проверить использование кеша эмбеддингов
4. Проверить батчинг запросов
5. Проверить статистику использования кеша

**Команда:**
```bash
cd tg-analyz
source .venv/bin/activate
python scripts/analysis/sync/test_v2.py
```

**Ожидаемые результаты:**
- Временные окна фильтруют задачи Asana
- Кеш эмбеддингов переиспользуется между запусками
- Батчинг снижает количество запросов к API
- Hit rate кеша > 0% при повторных запусках

### Этап 2: Интеграционное тестирование с MCP

**Цель:** Проверить полный цикл синхронизации через MCP

**Шаги:**
1. Запустить `sync_farma.py` с MCP клиентом
2. Проверить загрузку задач из Asana через MCP
3. Проверить сопоставление через V2 архитектуру
4. Проверить генерацию отчета
5. Проверить статистику кеша

**Команда:**
```bash
python scripts/analysis/sync/sync_farma.py
```

**Ожидаемые результаты:**
- Успешная загрузка задач через MCP
- Найдены совпадения с использованием временных окон
- Кеш эмбеддингов работает и переиспользуется
- Отчет сгенерирован с анализом покрытия

### Этап 3: Применение изменений (dry_run=False)

**Цель:** Применить изменения в Asana после проверки отчета

**Условия:**
- ✅ Отчет проверен и одобрен
- ✅ Качество сопоставления удовлетворительное
- ✅ Статистика кеша показывает эффективность

**Шаги:**
1. Запустить `sync_farma.py` с `dry_run=False`
2. Мониторить логи на наличие ошибок
3. Проверить обновленные задачи в Asana
4. Проверить созданные задачи в Asana
5. Проверить статистику кеша после выполнения

## Метрики успешности

### Локальное тестирование V2
- **Временные окна:** Задачи фильтруются по окнам
- **Кеш эмбеддингов:** Hit rate > 0% при повторных запусках
- **Батчинг:** Количество запросов к API снижено на ~98%
- **Время выполнения:** Быстрее за счет кеша и батчинга

### Интеграционное тестирование
- **Загрузка через MCP:** Успешно загружены все задачи проекта
- **Сопоставление:** Найдены совпадения с использованием V2 архитектуры
- **Отчет:** Сгенерирован с анализом покрытия и контекстом
- **Кеш:** Статистика показывает эффективное использование

### Производственное использование
- **Обновление задач:** Успешно обновлены существующие задачи
- **Создание задач:** Успешно созданы новые задачи для `telegram_only`
- **Качество:** Контекстные выжимки подтверждают корректность сопоставления
- **Эффективность:** Кеш снижает затраты на ~75-98%

## Логи и отчеты

- **Логи тестирования:** `tg-analyz/logs/test_v2_*.log`
- **Логи синхронизации:** `tg-analyz/logs/sync_asana_*.log`
- **Отчеты синхронизации:** `tg-analyz/results/farma/sync/sync_report.json`
- **Кеш эмбеддингов:** `tg-analyz/cache/embeddings/embeddings_cache.json`

## Оптимизации V2

### Экономия затрат
- **Батчинг:** ~98% экономии на запросах к API эмбеддингов
- **Кеш:** ~75-100% экономии на повторных запусках
- **Временные окна:** Снижение количества сравнений на ~60-80%

### Улучшение качества
- **Временные окна:** Повышение точности за счет контекстуального сопоставления
- **Двухэтапное совпадение:** GPT-5 используется только для потенциальных совпадений
- **Разные пороги:** Более гибкое сопоставление в зависимости от временного окна
