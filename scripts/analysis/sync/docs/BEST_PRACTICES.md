# Лучшие практики семантического сопоставления

Ключевые принципы работы с эмбеддингами и GPT-5 для сопоставления задач из переписок с проектными инструментами.

## 1. Компактные версии для эмбеддингов

### Проблема усреднения информации

Эмбеддинги усредняют информацию по всему тексту. При сравнении длинных текстов это приводит к "размыванию" важных деталей - ключевая информация теряется среди второстепенной.

**Решение:** Использовать компактные версии для эмбеддингов:
- Название + метаданные (даты, исполнитель)
- Первые 2000 символов описания (важнее начало)
- Ключевые моменты (топ-3-5)
- Полный текст использовать только для GPT-5 проверки

### Ограничения длины

OpenAI text-embedding-3-small имеет лимит ~8000 символов. При обрезке теряется конец текста.

**Решение:** 
- Использовать начало текста (обычно содержит основную информацию)
- Добавлять ключевые моменты из всего текста
- Для GPT-5 проверки использовать полный текст без обрезки

## 2. Двухэтапное сопоставление (Hybrid Search)

### Принцип работы

1. **Быстрый этап (эмбеддинги):** Предварительная фильтрация кандидатов
2. **Точный этап (GPT-5):** Финальная проверка топ-кандидатов

**Преимущества:**
- Экономия затрат (GPT-5 дороже эмбеддингов)
- Высокое качество (GPT-5 понимает контекст лучше)
- Скорость (эмбеддинги быстрее)

### Оптимизация порогов

- **Низкий порог (0.65):** Для потенциальных совпадений - отправлять на GPT-5 проверку
- **Высокий порог (0.75):** Для уверенных совпадений - можно использовать напрямую
- **Точные совпадения названий:** Приоритет, даже если эмбеддинги дают низкий score

## 3. Временные окна для контекстуального сопоставления

### Принцип

Задачи, созданные в близкое время, с большей вероятностью связаны между собой. Использование временных окон позволяет:
- Снизить количество сравнений (фильтрация по датам)
- Повысить точность (контекстуальное сопоставление)
- Оптимизировать затраты (меньше сравнений = меньше запросов)

### Реализация

- **Основное окно (±7 дней):** Высокий приоритет, низкий порог
- **Расширенное окно (±30 дней):** Средний приоритет, средний порог
- **Дальнее окно (все остальное):** Низкий приоритет, высокий порог

## 4. Кеширование эмбеддингов

### Переиспользование кеша

Кеш имеет смысл только если переиспользуется между запусками.

**Метаданные кеша:**
- `created_at` - когда создан эмбеддинг
- `last_used_at` - когда последний раз использован
- Статистика: hits/misses/hit rate

**Стратегия сохранения:**
- Периодическое сохранение (не после каждого запроса)
- Резервное копирование перед сохранением
- Очистка по возрасту (удаление старых записей)

**Экономия:**
- При повторных запусках: 75-100% экономии на эмбеддингах
- Hit rate > 50% считается хорошим показателем

## 5. Батчинг запросов к OpenAI

### Оптимизация затрат

OpenAI поддерживает батчинг до 2048 элементов. Использование батчей:
- Снижает количество запросов на ~98%
- Ускоряет обработку (параллельная обработка)
- Снижает затраты (меньше overhead на запрос)

**Рекомендации:**
- Размер батча: 100 элементов (баланс скорости и надежности)
- Для эмбеддингов: всегда использовать батчинг
- Для GPT-5: можно батчить через batch API для больших объемов (>50 проверок)

## 6. Предварительная суммаризация задач

### Принцип

Задачи Asana суммаризируются через GPT-5 Batch API для получения компактных версий:
- Удаление "воды", оставление только фактов
- Высокая концентрация полезной информации
- Метаданные (даты, исполнитель) добавляются структурированно

**Использование:**
- Для эмбеддингов: суммаризированная версия (компактная, лучше качество)
- Для GPT-5 проверки: полный текст (максимальная точность)

## Рекомендации для нашей системы

### Оптимизация текста для эмбеддингов

**Для Asana задач:**
- Название + метаданные (исполнитель, даты)
- Суммаризированная версия (через GPT-5 Batch API)
- Полный текст только для GPT-5

**Для Telegram задач:**
- Title + description
- Первые 1500 символов context (важнее начало)
- Полный context только для GPT-5

### Стратегия сопоставления

1. **Точные совпадения названий** - приоритет, даже при низком score эмбеддингов
2. **Эмбеддинги с компактными версиями** - быстрая фильтрация
3. **Временные окна** - контекстуальная фильтрация
4. **GPT-5 проверка** - для потенциальных совпадений (low_threshold <= score < similarity_threshold)
5. **Полный текст для GPT-5** - лучший контекст для финальной проверки

### Оптимизация затрат

- **Батчинг:** Всегда использовать для эмбеддингов (100 элементов)
- **Кеш:** Переиспользование между запусками (hit rate > 50%)
- **Двухэтапное сопоставление:** GPT-5 только для топ-кандидатов
- **Временные окна:** Снижение количества сравнений на 60-80%
- **Предварительная суммаризация:** Улучшение качества эмбеддингов

## Метрики качества

### Показатели эффективности кеша

- **Hit rate:** Процент попаданий в кеш (цель: > 50%)
- **Средний возраст записей:** Показывает актуальность кеша
- **Размер кеша:** Количество сохраненных эмбеддингов

### Показатели качества сопоставления

- **Покрытие:** Процент Telegram задач, для которых найдены совпадения
- **Точность:** Процент правильных совпадений (требует ручной проверки)
- **Время выполнения:** Скорость обработки (зависит от размера данных)

## Выводы

### Ключевые принципы

1. **Компактные версии для эмбеддингов** - улучшают качество сопоставления
2. **Полный текст для GPT-5** - обеспечивает точную финальную проверку
3. **Двухэтапное сопоставление** - баланс между качеством и затратами
4. **Временные окна** - контекстуальная фильтрация повышает точность
5. **Кеширование** - критично для переиспользования и экономии затрат
6. **Батчинг** - обязателен для оптимизации затрат на API
7. **Предварительная суммаризация** - улучшает качество эмбеддингов

### Применение в нашей системе

Наша реализация V2 архитектуры следует этим принципам:
- ✅ Компактные версии для эмбеддингов (embedding_text)
- ✅ Полный текст для GPT-5 (full_text)
- ✅ Двухэтапное сопоставление (эмбеддинги + GPT-5)
- ✅ Временные окна (TimeWindowMatcher)
- ✅ Кеш эмбеддингов (EmbeddingCache с переиспользованием)
- ✅ Батчинг запросов (100 элементов)
- ✅ Предварительная суммаризация (AsanaTaskSummarizer)
