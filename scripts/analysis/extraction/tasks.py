"""
–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ —Å–∂–∞—Ç—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
"""
import json
from typing import Dict, Any
from ..utils.gpt5_client import get_openai_client
from ..utils.response_parser import parse_gpt5_response, parse_json_response


def extract_tasks_from_compressed_thread(compressed_text: str, client=None) -> Dict[str, Any]:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ —Å–∂–∞—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ —Å –æ—Ç–º–µ—Ç–∫–æ–π –≤–µ—Ç–æ–∫ –æ–±—Å—É–∂–¥–µ–Ω–∏–π.
    
    Args:
        compressed_text: –°–∂–∞—Ç—ã–π —Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
        client: OpenAI –∫–ª–∏–µ–Ω—Ç (–µ—Å–ª–∏ None, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π)
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–æ–º 'tasks' —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
    """
    if client is None:
        client = get_openai_client()
    
    print(f"\nüìã –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ —Å–∂–∞—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞...")
    
    prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∂–∞—Ç—ã–π –¥–∏–∞–ª–æ–≥ –∏ –∏–∑–≤–ª–µ–∫–∏ –≤—Å–µ –∑–∞–¥–∞—á–∏, –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –∑–∞–ø—Ä–æ—Å—ã –∏ –¥–µ–¥–ª–∞–π–Ω—ã.

–î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ –æ–ø—Ä–µ–¥–µ–ª–∏:
1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
2. –ö—Ç–æ –ø–æ—Å—Ç–∞–≤–∏–ª/–æ–±—è–∑–∞–ª—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å
3. –î–µ–¥–ª–∞–π–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –°—Ç–∞—Ç—É—Å (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ/–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ/–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ) - –µ—Å–ª–∏ –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
5. –í –∫–∞–∫–æ–º —á–∞—Ç–µ –æ–±—Å—É–∂–¥–∞–ª–∞—Å—å
6. –í–µ—Ç–∫–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —É–ø–æ–º–∏–Ω–∞–ª–∞—Å—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Ç–∞—Ö, –æ—Ç–º–µ—Ç—å –≤—Å–µ)

–°–∂–∞—Ç—ã–π –¥–∏–∞–ª–æ–≥:
{compressed_text}

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "tasks": [
    {{
      "title": "–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ",
      "description": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
      "assignee": "–ö—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç",
      "deadline": "–î–∞—Ç–∞ –∏–ª–∏ —Å—Ä–æ–∫",
      "status": "–≤—ã–ø–æ–ª–Ω–µ–Ω–æ/–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ/–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ",
      "chats": ["–ß–∞—Ç1", "–ß–∞—Ç2"],
      "discussion_thread": "–í–µ—Ç–∫–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–≥–¥–µ –∏ –∫–∞–∫ –æ–±—Å—É–∂–¥–∞–ª–∞—Å—å –∑–∞–¥–∞—á–∞)",
      "context": "–§—Ä–∞–≥–º–µ–Ω—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å —ç—Ç–æ–π –∑–∞–¥–∞—á–µ–π"
    }}
  ]
}}"""
    
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º GPT-5 —á–µ—Ä–µ–∑ responses API
        system_prompt = "–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –∏–∑–≤–ª–µ–∫–∞—Ç—å –∑–∞–¥–∞—á–∏ –∏–∑ –ø–µ—Ä–µ–ø–∏—Å–æ–∫. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–º JSON."
        
        # –§–æ—Ä–º–∞—Ç –¥–ª—è responses API: input –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º —Å–ª–æ–≤–∞—Ä–µ–π —Å role/content
        response = client.responses.create(
            model="gpt-5",
            input=[
                {
                    "role": "system",
                    "content": system_prompt
                },
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            reasoning={"effort": "medium"}  # medium –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        )
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞
        response_text = parse_gpt5_response(response)
        
        if not response_text:
            raise Exception("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏")
        
        # –ü–∞—Ä—Å–∏–º JSON
        result = parse_json_response(response_text)
        
        if result is None:
            raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞")
        
        tasks = result.get("tasks", [])
        
        print(f"‚úì –ò–∑–≤–ª–µ—á–µ–Ω–æ {len(tasks)} –∑–∞–¥–∞—á")
        return result
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á: {e}")
        import traceback
        print(f"   –î–µ—Ç–∞–ª–∏: {traceback.format_exc()[:300]}")
        return {"tasks": []}

