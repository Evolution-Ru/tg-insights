# Telegram Transcript Pipeline

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–µ–ø–∏—Å–æ–∫ –∏–∑ Telegram.

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üì• **–≠–∫—Å–ø–æ—Ä—Ç —Å–æ–æ–±—â–µ–Ω–∏–π** –∏–∑ Telegram –≤ SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- üéôÔ∏è **–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ** —á–µ—Ä–µ–∑ T-bank Speech-to-Text API
- üìù **–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤** —á–µ—Ä–µ–∑ OpenAI API (batch processing)
- üìä **–ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–ø–∏—Å–æ–∫** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∏–Ω—Å–∞–π—Ç–æ–≤
- üíæ **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚ö° **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–∫ —Ö–æ—Ç–∏—Ç–µ, –≤ –ª—é–±—ã—Ö —Ü–µ–ª—è—Ö, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

## üìñ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#-–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
2. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
3. [–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è (STT)](#-—Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è-stt)
4. [–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π](#-–æ–±—Ä–∞–±–æ—Ç–∫–∞-—Å–æ–æ–±—â–µ–Ω–∏–π)
5. [–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞](#-—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ-–º–µ–¥–∏–∞)
6. [–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫](#-–∞–≤—Ç–æ–∑–∞–ø—É—Å–∫)
7. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#-–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
8. [Troubleshooting](#-troubleshooting)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone https://github.com/your-username/tg-transcript.git
cd tg-transcript

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3 -m venv .venv
source .venv/bin/activate  # Linux/macOS
# –∏–ª–∏
.venv\Scripts\activate  # Windows

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
cp .env.example .env

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env –∏ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ API –∫–ª—é—á–∏
nano .env  # –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
```

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ API –∫–ª—é—á–∏:**
- **Telegram API**: –ü–æ–ª—É—á–∏—Ç—å –Ω–∞ https://my.telegram.org/apps
- **T-bank STT API**: –ü–æ–ª—É—á–∏—Ç—å –Ω–∞ https://www.tbank.ru/openapi/
- **OpenAI API**: –ü–æ–ª—É—á–∏—Ç—å –Ω–∞ https://platform.openai.com/api-keys

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
mkdir -p data/accounts/your_account

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å .env –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∞–∫–∫–∞—É–Ω—Ç–∞
cp .env data/accounts/your_account/.env
```

### 4. –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

```bash
# –≠–∫—Å–ø–æ—Ä—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
python scripts/messages/process_all.py --account your_account --use-batch

# –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ
python scripts/stt/stt.tbank.py --account your_account --limit 100

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤
python scripts/media/download.py
```

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
tg-insights/
‚îú‚îÄ‚îÄ data/                     # üíæ –î–∞–Ω–Ω—ã–µ
‚îÇ   ‚îî‚îÄ‚îÄ accounts/            # –ê–∫–∫–∞—É–Ω—Ç—ã, –ë–î, –º–µ–¥–∏–∞
‚îÇ       ‚îî‚îÄ‚îÄ your_account/
‚îÇ           ‚îú‚îÄ‚îÄ messages.sqlite
‚îÇ           ‚îú‚îÄ‚îÄ media/
‚îÇ           ‚îî‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ scripts/                  # üîß –°–∫—Ä–∏–ø—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ messages/            # –≠–∫—Å–ø–æ—Ä—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ export_all.py   # –≠–∫—Å–ø–æ—Ä—Ç –∏–∑ Telegram
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ process_all.py  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ send.py         # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ summarizer/     # Batch —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ media/              # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ download.py     # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ
‚îÇ   ‚îî‚îÄ‚îÄ stt/                # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ stt.tbank.py    # T-bank STT
‚îÇ       ‚îî‚îÄ‚îÄ TbankClient.py  # T-bank API –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ logs/                     # üìù –í—Å–µ –ª–æ–≥–∏
‚îÇ   ‚îú‚îÄ‚îÄ process_loop.log
‚îÇ   ‚îú‚îÄ‚îÄ launchd.log
‚îÇ   ‚îî‚îÄ‚îÄ launchd.error.log
‚îú‚îÄ‚îÄ .venv/                    # Virtual environment (—Å–∫—Ä—ã—Ç–∞—è)
‚îú‚îÄ‚îÄ requirements.txt          # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ README.md                 # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## üé§ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è (STT)

### T-–±–∞–Ω–∫ STT (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** 0.3 –∫–æ–ø/—Å–µ–∫ = 108 —Ä—É–±/—á–∞—Å  
**–ö–∞—á–µ—Å—Ç–≤–æ:** —Ö–æ—Ä–æ—à–µ–µ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞  
**–°–∫–æ—Ä–æ—Å—Ç—å:** 10 –ø–æ—Ç–æ–∫–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

```bash
# –° –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
bash scripts/stt/run_tbank.sh --account your_account --limit 100

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é (—Ñ–ª–∞–≥ -u –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ª–æ–≥–æ–≤!)
python -u scripts/stt/stt.tbank.py --account your_account --limit 100

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π
python scripts/stt/stt.tbank.py --account your_account --check-only

# –£–∫–∞–∑–∞—Ç—å –ø—É—Ç–∏ –≤—Ä—É—á–Ω—É—é (–≤–º–µ—Å—Ç–æ --account)
python scripts/stt/stt.tbank.py \
  --db data/accounts/your_account/messages.sqlite \
  --media-dir data/accounts/your_account/media \
  --limit 100
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:** –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Ç—ã (dialog_denied)
2. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:** –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ –≤ WAV 16kHz mono (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ T-–±–∞–Ω–∫)
3. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞:** 10 —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ T-–±–∞–Ω–∫ API
4. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `operation_id` –≤ –ë–î –∏ –Ω–µ –∂–¥—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –∑–∞–±–∏—Ä–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≤–∏–¥–µ–æ –±–µ–∑ –∑–≤—É–∫–∞
- –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ñ–∞–π–ª—ã >5 –º–∏–Ω—É—Ç
- –õ–æ–≥–∏: `logs/stt_tbank_YYYYMMDD_HHMMSS.log`

### OpenAI Whisper (–¥–æ—Ä–æ–∂–µ, –Ω–æ –Ω–∞–¥—ë–∂–Ω–µ–µ)

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** 3.6 –∫–æ–ø/—Å–µ–∫ = 1,296 —Ä—É–±/—á–∞—Å  
**–ö–∞—á–µ—Å—Ç–≤–æ:** –æ—Ç–ª–∏—á–Ω–æ–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞

```bash
python scripts/stt/stt.whisper.py \
  --db data/accounts/your_account/messages.sqlite \
  --limit 100
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

| –°–µ—Ä–≤–∏—Å | –¶–µ–Ω–∞ | 1 —á–∞—Å | –°–∫–æ—Ä–æ—Å—Ç—å | –ö–∞—á–µ—Å—Ç–≤–æ |
|--------|------|-------|----------|----------|
| T-–±–∞–Ω–∫ | 0.3 –∫–æ–ø/—Å | 108‚ÇΩ | –°—Ä–µ–¥–Ω—è—è | –•–æ—Ä–æ—à–µ–µ |
| Whisper | 3.6 –∫–æ–ø/—Å | 1,296‚ÇΩ | –ë—ã—Å—Ç—Ä–∞—è | –û—Ç–ª–∏—á–Ω–æ–µ |

**–≠–∫–æ–Ω–æ–º–∏—è:** T-–±–∞–Ω–∫ –≤ **12 —Ä–∞–∑ –¥–µ—à–µ–≤–ª–µ**!

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API –∫–ª—é—á–µ–π

–í `data/accounts/your_account/.env`:
```bash
# T-–±–∞–Ω–∫ STT
TBANK_API_KEY=your_key
TBANK_SECRET_KEY=your_secret

# OpenAI Whisper
OPENAI_API_KEY=sk-...

# Telegram
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_SESSION_STRING=your_session
```

---

## üì¨ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

### –†–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫

```bash
python scripts/messages/process_all.py \
  --account your_account \
  --use-batch \
  --max-dialogs 10000
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `--account` - –∏–º—è –∞–∫–∫–∞—É–Ω—Ç–∞ (–ø–∞–ø–∫–∞ –≤ data/accounts/)
- `--use-batch` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch API OpenAI (–¥–µ—à–µ–≤–ª–µ)
- `--max-dialogs` - –º–∞–∫—Å. –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `--limit` - –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

### –ü–µ—Ä–≤–∏—á–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç

```bash
# –í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –≤ –ë–î
python scripts/messages/export_all.py \
  --account your_account \
  --all-dialogs
```

### –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—É–º–º–∞—Ä–∏–∑—É–µ—Ç –¥–∏–∞–ª–æ–≥–∏ —á–µ—Ä–µ–∑ OpenAI batch API:

1. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç batch –≤ OpenAI (–¥–µ—à–µ–≤–ª–µ –Ω–∞ 50%)
3. –ñ–¥—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–¥–æ 24 —á–∞—Å–æ–≤)
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î

---

## üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞

```bash
# –°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤
# –§–∏–ª—å—Ç—Ä: —Ç–æ–ª—å–∫–æ < 5 –º–∏–Ω—É—Ç, –±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–æ–∫
# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: 20 –ø–æ—Ç–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
python scripts/media/download.py
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –í—ã–±–∏—Ä–∞–µ—Ç –º–µ–¥–∏–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤ –∏–∑ –ë–î
2. –§–∏–ª—å—Ç—Ä—É–µ—Ç: —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏)
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ Telegram API **–ë–ï–ó —Å–∫–∞—á–∏–≤–∞–Ω–∏—è**
4. –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ñ–∞–π–ª—ã >5 –º–∏–Ω—É—Ç
5. **–°–∫–∞—á–∏–≤–∞–µ—Ç 20 —Ñ–∞–π–ª–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π FloodWait
6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `data/accounts/{account}/media/`
7. –û–±–Ω–æ–≤–ª—è–µ—Ç `media_path` –≤ –ë–î

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: 20 –ø–æ—Ç–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Telegram rate limits (FloodWaitError)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –∏ –≤—Ä–µ–º—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –¥–æ–ª–≥–æ–π —Ä–∞–±–æ—Ç—ã (—á–∞—Å—ã)

**–°–∫–∞—á–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
```
data/accounts/your_account/media/
‚îú‚îÄ‚îÄ {chat_id}_{message_id}.oga  # –ê—É–¥–∏–æ
‚îú‚îÄ‚îÄ {chat_id}_{message_id}.mp4  # –í–∏–¥–µ–æ
‚îî‚îÄ‚îÄ {chat_id}_{message_id}.wav  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è STT
```

---

## ‚öôÔ∏è –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫:

**macOS:** launchd
```bash
# –°–æ–∑–¥–∞–π—Ç–µ plist —Ñ–∞–π–ª ~/Library/LaunchAgents/com.tginsights.process.plist
# —Å–æ –∑–∞–ø—É—Å–∫–æ–º scripts/messages/process_all.py
```

**Linux:** cron –∏–ª–∏ systemd
```bash
# –î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É –≤ crontab (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤)
0 */6 * * * cd /path/to/tg-insights && .venv/bin/python scripts/messages/process_all.py --account your_account
```

**Windows:** Task Scheduler
- –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Python —Å–∫—Ä–∏–ø—Ç–∞

### –õ–æ–≥–∏

```bash
# –û—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
tail -f logs/process.log

# –õ–æ–≥–∏ launchd
tail -f logs/launchd.log
tail -f logs/launchd.error.log
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫:**
1. launchd –∑–∞–ø—É—Å–∫–∞–µ—Ç `run_process_loop.sh` –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã
2. –°–∫—Ä–∏–ø—Ç –≤ —Ü–∏–∫–ª–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç `process_all.py` –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –º–µ–¥–∏–∞, —Å—É–º–º–∞—Ä–∏–∑–∏—Ä—É–µ—Ç

---

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

SQLite –±–∞–∑–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `data/accounts/{account}/messages.sqlite`

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

```sql
-- –°–æ–æ–±—â–µ–Ω–∏—è
messages (
  chat_id,          -- ID —á–∞—Ç–∞
  message_id,       -- ID —Å–æ–æ–±—â–µ–Ω–∏—è
  date,             -- –î–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  message,          -- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  media_path,       -- –ü—É—Ç—å –∫ —Å–∫–∞—á–∞–Ω–Ω–æ–º—É –º–µ–¥–∏–∞
  transcript,       -- –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
  transcript_model, -- –ú–æ–¥–µ–ª—å STT (tbank/whisper)
  duration_seconds, -- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–µ–¥–∏–∞
  tbank_operation_id -- ID –æ–ø–µ—Ä–∞—Ü–∏–∏ T-–±–∞–Ω–∫
)

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
users (
  user_id,
  first_name,
  username,
  phone
)
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
sqlite3 data/accounts/your_account/messages.sqlite \
  "SELECT COUNT(*) FROM messages"

# –ù–µ–ø—Ä–æ—Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞
sqlite3 data/accounts/your_account/messages.sqlite \
  "SELECT COUNT(*) FROM messages 
   WHERE media_path IS NOT NULL 
   AND transcript IS NULL"

# –†–∞–∑–º–µ—Ä –ë–î
du -h data/accounts/your_account/messages.sqlite
```

---

## üîß Troubleshooting

### –û—à–∏–±–∫–∞: "No module named 'telethon'"

```bash
source .venv/bin/activate
pip install -r requirements.txt
```

### –û—à–∏–±–∫–∞: "Could not find .env"

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
ls -la data/accounts/your_account/.env

# –°–æ–∑–¥–∞—Ç—å –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
cp data/accounts/your_account/.env.example data/accounts/your_account/.env
```

### –û—à–∏–±–∫–∞: "OPENAI_API_KEY not set"

–î–æ–±–∞–≤–∏—Ç—å –≤ `data/accounts/your_account/.env`:
```bash
OPENAI_API_KEY=sk-...
```

### –°–∫—Ä–∏–ø—Ç –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –º–µ–¥–∏–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –µ—Å—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (Ctrl+C)
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
ls data/accounts/your_account/media/ | wc -l

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ –ë–î
sqlite3 data/accounts/your_account/messages.sqlite \
  "SELECT COUNT(*) FROM messages WHERE media_path IS NOT NULL"
```

### T-–±–∞–Ω–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ (OPUS –≤–º–µ—Å—Ç–æ LINEAR16)

**–†–µ—à–µ–Ω–∏–µ:** —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ FFmpeg
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FFmpeg
ffmpeg -version

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç (macOS)
brew install ffmpeg
```

### launchd –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å plist
plutil -lint ~/Library/LaunchAgents/com.tginsights.process_all.plist

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
cat logs/launchd.error.log

# –ü—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
chmod +x scripts/messages/run_process_loop.sh
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ë–î –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ù–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep process_all

# –£–±–∏—Ç—å –ª–∏—à–Ω–∏–µ
pkill -f process_all.py

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
launchctl kickstart -k gui/$(id -u)/com.tginsights.process_all
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

```bash
# –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
> logs/process_loop.log
> logs/launchd.log
> logs/launchd.error.log
```

---

## üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .venv/bin/activate

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
flake8 scripts/

# –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ (10 —Å–æ–æ–±—â–µ–Ω–∏–π)
python scripts/messages/process_all.py \
  --account your_account \
  --use-batch \
  --limit 10

# –¢–µ—Å—Ç STT (5 —Ñ–∞–π–ª–æ–≤)
python scripts/stt/stt.tbank.py \
  --db data/accounts/your_account/messages.sqlite \
  --limit 5
```

---

## üîê API –∫–ª—é—á–∏

–í—Å–µ –∫–ª—é—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `data/accounts/{account}/.env`:

```bash
# Telegram
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_SESSION_STRING=your_session

# OpenAI Whisper
OPENAI_API_KEY=sk-...

# T-–±–∞–Ω–∫ STT
TBANK_API_KEY=your_tbank_key
TBANK_SECRET_KEY=your_tbank_secret
```

---

## üìö –°—Å—ã–ª–∫–∏

- [T-–±–∞–Ω–∫ STT API](https://www.tbank.ru/kassa/dev/speech-to-text/)
- [OpenAI Whisper API](https://platform.openai.com/docs/guides/speech-to-text)
- [Telethon Documentation](https://docs.telethon.dev/)

---

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è

Open-source –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram –¥–∞–Ω–Ω—ã–º–∏.
