# План рефакторинга структуры проекта

## Текущие проблемы:

1. **analyze_farma_tasks.py** - 1984 строки, монолитный файл со всеми функциями
2. Утилиты для батчей разбросаны в корне scripts/
3. Результаты работы в корне проекта (farma_compressed_parts/, farma_thread_*.txt)
4. Дублирование кода (парсинг GPT-5, работа с клиентом)

## Предлагаемая структура:

```
tg-analyz/
  scripts/
    analysis/                    # Новый модуль для анализа задач/проектов
      __init__.py
      compression/              # Сжатие диалогов
        __init__.py
        chunking.py             # Разбиение на части по датам ✅
        compression.py          # Сжатие через GPT-5
        batch_processing.py     # Batch обработка
        sliding_window.py       # Скользящая выжимка
      embeddings/               # Эмбеддинги
        __init__.py
        embeddings.py           # Работа с эмбеддингами
        drilldown.py             # Drill-down функциональность
      extraction/               # Извлечение задач/проектов
        __init__.py
        tasks.py                # Извлечение задач
        projects.py             # Извлечение проектов
        grouping.py             # Группировка и дедупликация
      utils/                    # Утилиты
        __init__.py
        formatting.py           # Форматирование потоков ✅
        gpt5_client.py          # Общий клиент GPT-5 ✅
        response_parser.py     # Парсинг ответов GPT-5 ✅
        db.py                   # Работа с БД
      analyze_farma.py          # Главный скрипт (тонкий, ~100 строк)
    batch/                      # Утилиты для батчей
      __init__.py
      check.py                  # check_batches.py
      download.py               # download_batch_results.py
      process.py                # process_batch_results.py
      test_single.py            # test_batch_single.py
    messages/                   # Существующая структура (без изменений)
    artifacts/                  # Существующая структура (без изменений)
    stt/                        # Существующая структура (без изменений)
    media/                      # Существующая структура (без изменений)
  results/                      # Результаты работы (новое)
    farma/
      compressed_parts/         # Сжатые части
      embeddings/               # Эмбеддинги
      extracted/                # Извлеченные задачи/проекты
      threads/                   # Исходные и сжатые потоки
```

## Преимущества:

1. **Модульность** - каждый модуль отвечает за свою область
2. **Переиспользование** - общие утилиты в utils/
3. **Читаемость** - легко найти нужный функционал
4. **Тестируемость** - каждый модуль можно тестировать отдельно
5. **Масштабируемость** - легко добавлять новые функции

## План миграции:

1. ✅ Создать структуру папок
2. ✅ Создать базовые модули (utils, chunking, formatting)
3. ✅ Перенести функции сжатия
4. ✅ Перенести функции эмбеддингов
5. ✅ Перенести функции извлечения
6. ✅ Создать тонкий главный скрипт
7. ✅ Перенести утилиты батчей
8. ✅ Обновить пути к результатам

## Статус рефакторинга:

✅ **РЕФАКТОРИНГ КОДА ЗАВЕРШЕН!**
⏳ **РЕСТРУКТУРИЗАЦИЯ ПРОЕКТА ЗАВЕРШЕНА!**
⏳ **ТЕСТИРОВАНИЕ - В ПРОЦЕССЕ**

### Выполнено:

#### 1. Модульная структура кода ✅
- ✅ Создана модульная структура `scripts/analysis/`
- ✅ Все функции разбиты по модулям (compression, embeddings, extraction, utils)
- ✅ Создан главный скрипт `analyze_farma.py` (~200 строк вместо 1984)
- ✅ Все модули имеют правильные импорты и экспорты

#### 2. Организация утилит ✅
- ✅ Утилиты батчей перенесены в `scripts/batch/`:
  - `check_batches.py` → `batch/check.py`
  - `download_batch_results.py` → `batch/download.py`
  - `process_batch_results.py` → `batch/process.py`
  - `test_batch_single.py` → `batch/test_single.py`
- ✅ Старые файлы удалены из корня `scripts/`

#### 3. Структура результатов ✅
- ✅ Создана структура `results/farma/` для результатов работы:
  - `results/farma/compressed_parts/` - сжатые части диалогов
  - `results/farma/embeddings/` - эмбеддинги
  - `results/farma/extracted/` - извлеченные задачи и проекты
  - `results/farma/threads/` - исходные и сжатые потоки
- ✅ Файлы из корня проекта перемещены в правильные директории
- ✅ Обновлены пути к результатам во всех скриптах

#### 4. Реструктуризация проекта ✅
- ✅ `data/accounts/` → `accounts/` (убрана лишняя вложенность)
- ✅ Обновлены все пути в коде (9 файлов):
  - `scripts/messages/export_all.py`
  - `scripts/messages/process_all.py`
  - `scripts/messages/block_large_groups.py`
  - `scripts/messages/get_user_info.py`
  - `scripts/messages/send.py`
  - `scripts/stt/stt.tbank.py`
  - `scripts/media/download.py`
  - `scripts/artifacts/test_prompts.py`
  - `scripts/analysis/analyze_farma.py`
- ✅ Удалены ненужные файлы:
  - `.vscode/` (работа через Cursor)
  - `scripts/analyze_farma_tasks.py` (заменен на модульную версию)
  - `farma_compressed_parts/` (старая структура)
- ✅ Логи реорганизованы:
  - Логи из `priv-tg-workers/messages-tools/` перемещены в `logs/`
  - Старые логи (>30 дней) очищены
- ✅ Конфиги перемещены:
  - `local/com.tginsights.process_all.plist` → `config/`
  - `local/run_process_loop.sh` → `config/`
- ✅ Обновлен `.gitignore` под новую структуру

#### 5. Документация ✅
- ✅ Создан `scripts/analysis/README.md` с описанием модульной структуры
- ✅ Обновлен основной `README.md` с информацией о новом модуле анализа
- ✅ Обновлена документация в `docs/CURRENT_STATE.md`

### Результат рефакторинга:
- Монолитный файл на 1984 строки разбит на модульную структуру
- Код стал модульным, читаемым и поддерживаемым
- Легко добавлять новые функции и тестировать отдельные модули
- Все утилиты организованы по назначению
- Проект имеет чистую структуру без лишней вложенности
- Все пути обновлены и работают корректно

---

## Следующие задачи:

### ⏳ Задача: Полное тестирование системы после рефакторинга

**Цель:** Убедиться, что после рефакторинга все компоненты работают корректно, как раньше, и новые функции также функционируют.

**Что нужно протестировать:**

#### 1. Модуль анализа переписок (`scripts/analysis/`)
- [ ] **Сбор сообщений из БД**
  - Проверить подключение к БД (`accounts/ychukaev/messages.sqlite`)
  - Проверить получение сообщений из указанных чатов
  - Проверить обработку отсутствующих чатов

- [ ] **Форматирование сообщений**
  - Проверить `format_messages_as_thread()` - корректное форматирование потока
  - Проверить группировку по дням
  - Проверить обработку пустых сообщений

- [ ] **Сжатие диалогов**
  - Проверить `split_thread_by_dates()` - разбиение на части
  - Проверить `compress_chunk()` - сжатие отдельных чанков
  - Проверить `process_chunks_via_batch()` - batch обработку
  - Проверить кеширование результатов (SHA256 хеши)
  - Проверить обработку отсутствующих результатов (fallback)
  - Проверить `apply_sliding_window()` - скользящее окно

- [ ] **Эмбеддинги**
  - Проверить `get_embedding()` - генерацию эмбеддингов
  - Проверить `save_embeddings_for_level()` - сохранение
  - Проверить `cosine_similarity_embedding()` - расчет схожести

- [ ] **Извлечение задач и проектов**
  - Проверить `extract_tasks_from_compressed_thread()` - извлечение задач
  - Проверить `extract_projects_with_drilldown()` - извлечение проектов с drill-down
  - Проверить `find_similar_tasks()` - поиск похожих задач
  - Проверить `group_and_deduplicate_tasks()` - группировку и дедупликацию

- [ ] **Главный скрипт `analyze_farma.py`**
  - Проверить полный цикл работы от начала до конца
  - Проверить сохранение результатов в правильные директории
  - Проверить обработку ошибок

#### 2. Утилиты батчей (`scripts/batch/`)
- [ ] **check.py** - проверка статусов батчей
- [ ] **download.py** - скачивание результатов батчей
- [ ] **process.py** - обработка результатов батчей
- [ ] **test_single.py** - тестирование одного запроса

#### 3. Существующие модули (проверка совместимости)
- [ ] **scripts/messages/export_all.py** - экспорт сообщений (проверить пути к `accounts/`)
- [ ] **scripts/messages/process_all.py** - обработка сообщений (проверить пути)
- [ ] **scripts/messages/send.py** - отправка сообщений
- [ ] **scripts/stt/stt.tbank.py** - транскрибация (проверить пути)
- [ ] **scripts/media/download.py** - скачивание медиа (проверить пути)
- [ ] **scripts/artifacts/** - извлечение артефактов (проверить пути)

#### 4. Интеграционное тестирование
- [ ] Полный цикл: экспорт → обработка → анализ → извлечение задач
- [ ] Проверить работу с реальными данными из БД
- [ ] Проверить обработку больших объемов данных
- [ ] Проверить работу с batch API OpenAI

#### 5. Проверка структуры проекта
- [ ] Все пути корректны (нет ссылок на старые `data/accounts/`)
- [ ] Результаты сохраняются в правильные директории
- [ ] Логи пишутся в `logs/`
- [ ] Конфиги находятся в `config/`

**Ожидаемый результат:**
- Все компоненты работают как до рефакторинга
- Новые модульные функции работают корректно
- Нет ошибок связанных с путями
- Результаты сохраняются в правильных местах
- Система готова к продакшн использованию

**Критерии завершения:**
- ✅ Все тесты пройдены успешно
- ✅ Нет критических ошибок
- ✅ Все пути работают корректно
- ✅ Результаты сохраняются правильно
- ✅ Документация актуальна

